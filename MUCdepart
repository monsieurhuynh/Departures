<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MUC Monitor Debug</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .refresh-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 pb-10">

    <header class="bg-[#003865] text-white p-5 shadow-lg flex justify-between items-center">
        <h1 class="text-xl font-bold">M√ºnchen Live</h1>
        <button onclick="fetchAllData()" id="refreshBtn" class="bg-blue-600 p-2 rounded-full">üîÑ</button>
    </header>

    <main class="p-4 max-w-lg mx-auto space-y-6">
        <div id="status-msg" class="text-[10px] text-slate-400 text-center">Initialisiere...</div>
        
        <section>
            <h2 class="text-xs font-bold text-slate-500 uppercase mb-3">MVV Abfahrten</h2>
            <div id="mvv-container" class="space-y-4"></div>
        </section>

        <section>
            <h2 class="text-xs font-bold text-slate-500 uppercase mb-3">Lufthansa Ankunft (MUC)</h2>
            <div id="flight-container" class="bg-white rounded-2xl shadow-sm overflow-hidden"></div>
        </section>
    </main>

    <script>
        const STATIONS = [
            { id: "de:09162:144", name: "Winfriedstra√üe" },
            { id: "de:09162:646", name: "Nymphenburg S√ºd" },
            { id: "de:09162:10", name: "Laim (S-Bahn)" }
        ];

        async function fetchWithProxy(url) {
            // Wir probieren einen alternativen Proxy, falls corsproxy.io zickt
            const proxies = [
                "https://api.allorigins.win/raw?url=",
                "https://corsproxy.io/?"
            ];
            
            console.log("Fetching:", url);
            try {
                const response = await fetch(proxies[0] + encodeURIComponent(url));
                if (!response.ok) throw new Error("Proxy Error");
                return await response.json();
            } catch (e) {
                console.warn("Erster Proxy fehlgeschlagen, versuche zweiten...");
                const response = await fetch(proxies[1] + encodeURIComponent(url));
                return await response.json();
            }
        }

        async function renderMVV() {
            const container = document.getElementById('mvv-container');
            container.innerHTML = '';
            
            for (const station of STATIONS) {
                try {
                    const data = await fetchWithProxy(`https://www.mvg.de/api/bgw-pt/v3/departures?globalId=${station.id}`);
                    
                    // MVG gibt manchmal ein Array, manchmal ein Objekt mit Key "departures" zur√ºck
                    const departures = Array.isArray(data) ? data : (data.departures || []);
                    
                    let html = `<div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-slate-800 border-b pb-2 mb-2">${station.name}</h3>`;

                    if (departures.length === 0) {
                        html += `<p class="text-xs text-slate-400">Keine aktuellen Abfahrten.</p>`;
                    }

                    departures.slice(0, 3).forEach(dep => {
                        const time = new Date(dep.realtimeDepartureTime || dep.plannedDepartureTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        html += `
                            <div class="flex justify-between items-center py-1">
                                <span class="bg-blue-100 text-blue-800 text-[10px] px-2 py-0.5 rounded font-bold">${dep.label}</span>
                                <span class="text-sm text-slate-600 truncate flex-1 px-3 text-left">${dep.destination}</span>
                                <span class="text-sm font-bold">${time}</span>
                            </div>`;
                    });

                    html += `</div>`;
                    container.innerHTML += html;
                } catch (e) {
                    console.error("MVV Error f√ºr " + station.name, e);
                    container.innerHTML += `<div class="p-4 bg-red-50 text-red-500 rounded-xl text-[10px]">Verbindung zu ${station.name} fehlgeschlagen.</div>`;
                }
            }
        }

        async function renderFlights() {
            const container = document.getElementById('flight-container');
            try {
                const now = Math.floor(Date.now() / 1000);
                const data = await fetchWithProxy(`https://opensky-network.org/api/flights/arrival?airport=EDDM&begin=${now - 7200}&end=${now}`);
                
                const lhFlights = data.filter(f => f.callsign && f.callsign.trim().startsWith('DLH')).slice(0, 5);

                if (lhFlights.length === 0) {
                    container.innerHTML = `<div class="p-6 text-center text-slate-400 text-xs">Aktuell keine Lufthansa-Daten verf√ºgbar.</div>`;
                    return;
                }

                let html = `<table class="w-full text-sm"><tbody class="divide-y">`;
                lhFlights.forEach(f => {
                    const time = new Date(f.lastSeen * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    html += `<tr class="p-4"><td class="p-3 font-bold text-blue-900">${f.callsign}</td><td class="p-3 text-right font-mono">${time}</td></tr>`;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            } catch (e) {
                console.error("Flight Error", e);
                container.innerHTML = `<div class="p-6 text-center text-red-400 text-[10px]">Flugdaten-API Limit erreicht.</div>`;
            }
        }

        function fetchAllData() {
            document.getElementById('status-msg').innerText = "Aktualisiere...";
            Promise.all([renderMVV(), renderFlights()]).then(() => {
                document.getElementById('status-msg').innerText = "Stand: " + new Date().toLocaleTimeString();
            });
        }

        fetchAllData();
    </script>
</body>
</html>
