<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MUC Live Monitor</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/725/725300.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .refresh-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 font-sans pb-10">

    <header class="bg-[#003865] text-white p-5 shadow-lg sticky top-0 z-20 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold tracking-tight">M√ºnchen Monitor</h1>
            <p class="text-xs text-blue-200 opacity-80" id="last-update">Lade Daten...</p>
        </div>
        <button onclick="fetchAllData()" id="refreshBtn" class="bg-blue-600/30 hover:bg-blue-600/50 p-3 rounded-full transition-all active:scale-90">
            <span id="refreshIcon" class="block">üîÑ</span>
        </button>
    </header>

    <main class="p-4 max-w-lg mx-auto space-y-6">
        
        <section>
            <div class="flex items-center space-x-2 mb-3">
                <span class="text-xl">üöÜ</span>
                <h2 class="text-sm font-bold text-slate-500 uppercase tracking-widest">MVV Haltestellen</h2>
            </div>
            <div id="mvv-container" class="space-y-4">
                <div class="animate-pulse bg-white h-24 rounded-2xl"></div>
            </div>
        </section>

        <section>
            <div class="flex items-center space-x-2 mb-3">
                <span class="text-xl">‚úàÔ∏è</span>
                <h2 class="text-sm font-bold text-slate-500 uppercase tracking-widest">Lufthansa @ MUC</h2>
            </div>
            <div id="flight-container" class="bg-white rounded-2xl shadow-sm overflow-hidden border border-slate-200">
                <div class="p-8 text-center text-slate-400">Suche LH-Fl√ºge...</div>
            </div>
        </section>

    </main>

    <script>
        // Konfiguration
        const STATIONS = [
            { id: "de:09162:144", name: "Winfriedstra√üe" },
            { id: "de:09162:646", name: "Nymphenburg S√ºd" },
            { id: "de:09162:10", name: "Laim (S-Bahn)" }
        ];

        // Hilfsfunktion f√ºr CORS-Proxy (umgeht Browser-Sperren)
        async function fetchWithProxy(url) {
            const proxy = "https://corsproxy.io/?";
            const response = await fetch(proxy + encodeURIComponent(url));
            if (!response.ok) throw new Error("Network error");
            return await response.json();
        }

        async function renderMVV() {
            const container = document.getElementById('mvv-container');
            container.innerHTML = '';
            
            for (const station of STATIONS) {
                try {
                    const data = await fetchWithProxy(`https://www.mvg.de/api/bgw-pt/v3/departures?globalId=${station.id}`);
                    const departures = data.slice(0, 3); // Top 3 Abfahrten
                    
                    let html = `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-slate-800 flex justify-between">
                                ${station.name}
                                <span class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-400">MVV</span>
                            </h3>
                            <div class="mt-3 space-y-3">
                    `;

                    departures.forEach(dep => {
                        const time = new Date(dep.realtimeDepartureTime || dep.plannedDepartureTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const isDelayed = dep.realtime && (dep.realtimeDepartureTime !== dep.plannedDepartureTime);
                        
                        html += `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <span class="w-8 h-5 flex items-center justify-center rounded text-[10px] font-bold text-white ${getLineColor(dep.label)}">${dep.label}</span>
                                    <span class="text-sm font-medium text-slate-600 truncate max-w-[140px]">${dep.destination}</span>
                                </div>
                                <span class="text-sm font-bold ${isDelayed ? 'text-red-500' : 'text-slate-900'}">${time}</span>
                            </div>
                        `;
                    });

                    html += `</div></div>`;
                    container.innerHTML += html;
                } catch (e) {
                    container.innerHTML += `<div class="p-4 bg-red-50 text-red-500 rounded-xl text-xs">Fehler bei ${station.name}</div>`;
                }
            }
        }

        function getLineColor(label) {
            if (label.startsWith('S')) return 'bg-green-600';
            if (label.startsWith('U')) return 'bg-blue-600';
            if (parseInt(label) < 30) return 'bg-red-500'; // Tram
            return 'bg-blue-400'; // Bus
        }

        async function renderFlights() {
            const container = document.getElementById('flight-container');
            try {
                const now = Math.floor(Date.now() / 1000);
                const arrivals = await fetchWithProxy(`https://opensky-network.org/api/flights/arrival?airport=EDDM&begin=${now - 7200}&end=${now}`);
                
                // Filtere Lufthansa (Callsign beginnt mit DLH)
                const lhFlights = arrivals.filter(f => f.callsign && f.callsign.trim().startsWith('DLH')).slice(0, 6);

                if (lhFlights.length === 0) {
                    container.innerHTML = `<div class="p-8 text-center text-slate-400 text-sm">Aktuell keine Lufthansa-Ank√ºnfte erfasst.</div>`;
                    return;
                }

                let html = `<table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-400 font-bold text-[10px] uppercase">
                        <tr><th class="p-4">Flug</th><th class="p-4">Herkunft</th><th class="p-4 text-right">Landung</th></tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">`;
                
                lhFlights.forEach(f => {
                    const time = new Date(f.lastSeen * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    html += `
                        <tr class="active:bg-slate-50">
                            <td class="p-4 font-bold text-blue-900">${f.callsign.trim()}</td>
                            <td class="p-4 text-slate-500">${f.estDepartureAirport || '---'}</td>
                            <td class="p-4 text-right font-mono font-bold">${time}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table>`;
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<div class="p-8 text-center text-red-400 text-xs">Flugdaten konnten nicht geladen werden.</div>`;
            }
        }

        function fetchAllData() {
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('refresh-spin');
            
            document.getElementById('last-update').innerText = "Aktualisiere...";

            Promise.all([renderMVV(), renderFlights()]).then(() => {
                const now = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                document.getElementById('last-update').innerText = "Zuletzt aktualisiert: " + now;
                setTimeout(() => icon.classList.remove('refresh-spin'), 800);
            });
        }

        // Automatischer Start
        fetchAllData();
        // Alle 2 Minuten auto-refresh
        setInterval(fetchAllData, 120000);
    </script>
</body>
</html>
